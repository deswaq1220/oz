(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1506],{24009:function(t,e,n){"use strict";n.d(e,{wk:function(){return R},hY:function(){return A},$w:function(){return N},Ov:function(){return P},kc:function(){return M}});var r=n(52983),a=n(19325),c=n(74858);n(71461);var l=n(93935),o=n(63893),u=n(49258),i=n(28554);(0,c.atom)({key:"@wrtn/chat/chatInputState",default:""}),(0,c.atom)({key:"@wrtn/chat/chatInputTypeState",default:"default"}),(0,c.atom)({key:"@wrtn/chat/chatListState",default:[]}),(0,c.atom)({key:"selectedMessagePairsState",default:{}}),(0,c.atom)({key:"nonLoginGenerateLimitState",default:!1}),(0,c.atom)({key:"@wrtn/chat/chatIdState",default:null}),(0,c.atom)({key:"@wrtn/chat/chatScrollToBottomState",default:()=>{}}),(0,c.atom)({key:"@wrtn/chat/chatTooltipTutorialState",default:[!1,!1,!1]}),(0,c.atom)({key:"@wrtn/chat/currentFileState",default:null}),(0,c.atom)({key:"@wrtn/chat/fileUploadingState",default:!1}),(0,c.atom)({key:"@wrtn/chat/currentNewState",default:null}),(0,c.atom)({key:"@wrtn/chat/fileLoadingProgressState",default:0}),(0,c.atom)({key:"isStreamingState",default:!1});let d=(0,c.atom)({key:"generateStatusState",default:"ready"}),s={list:()=>"/chat",get:t=>""===t?null:"/chat/".concat(t)};var p=n(49069);let h=()=>u.ApiInstance.BE.post("/chat"),f=t=>u.ApiInstance.BE.put("/chat/".concat(t.chatId),{topic:t.topic}),v=t=>u.ApiInstance.BE.put("/api/v2/chat/delete",{chatIds:t}),A=t=>{let{LoadingIndicator:e}=t,n=(0,a.useAlert)(),{mutate:r}=(0,p.kY)(),{collectEvent:c}=(0,l.zX9)(),o=async()=>{let t=await h();return(0,l.tv0)("GPT4T_ALERT")||(n.show("이제 채팅방에서 하나의 모델만 선택해서 대화를 이어나가보세요."),(0,l.coT)("GPT4T_ALERT",!0)),r(s.list()),c("create_chat",{chat_type:"main"}),t},u=async t=>{e.show(),await v(t);let n=await r(s.list())||[];return e.hide(),n},i=async t=>{e.show(),await f(t),await r(s.list()),await r(s.get(t.chatId)),e.hide()},d=()=>{r(s.list(),void 0,{revalidate:!0})};return{createChatMutation:o,deleteChatsMutation:u,updateChatMutation:i,refreshChatListMutation:d}};function C(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"cannot find context provider";return()=>{let n=r.useContext(t);if(null===n)throw Error(e);return n}}n(97458);let x=r.createContext(null),m=r.createContext(null);C(m,"[ChatContextProvider] cannot find context provider"),C(x,"[ChatContextProvider] cannot find context provider");let w=r.createContext(null),k=r.createContext(null);C(k,"[UpdateChatInputContextProvider] cannot find context provider"),C(w,"[ChatInputContextProvider] cannot find context provider");let y=r.createContext(null),E=r.createContext(null);C(y,"[ChipContext] cannot find context provider"),C(E,"[UpdateChipContext] cannot find context provider");let T=r.createContext(null),g=r.createContext(null);C(T,"[FileContext] cannot find context provider"),C(g,"[UpdateFileContext] cannot find context provider");let _=r.createContext(null);C(_,"[TemplateContext] cannot find context provider");let S=r.createContext(null),b=r.createContext(null);C(S,"[ImageContext] cannot find context provider"),C(b,"[UpdateImageContext] cannot find context provider");var L=n(8620);let I=new L.x;function M(t){let{onMessage:e,onData:n,onOpen:a,onMessageError:c,onExceptionError:i,onStartStream:d,onStopStream:s,onIdle:p,onIdleTimeout:h}=t,f=r.useRef(null),v=r.useRef(null),A=(0,r.useRef)(),C=(0,r.useCallback)((t,r,d)=>new Promise((s,C)=>{v.current=t,f.current=r,t.build().then(async t=>{let f=await u.WrtnAccessTokenManager.getValidTokenAsync();A.current=new o.AO(t.url,{method:t.method,headers:{Authorization:"Bearer ".concat(d||f),"Content-Type":"application/json","x-wrtn-id":(0,l.ejW)("__w_id")},body:t.body},{idleThresholdInMs:100,reconnectTimeInMs:45e3,connectionTimeoutInMs:45e3,maxIdleTimeoutInMs:45e3}),A.current.addEventListener("open",t=>{null==a||a(t,r)}),A.current.addEventListener("idle",t=>{null==p||p(t)}),A.current.addEventListener("timeout",()=>{A.current&&(A.current.close(),null==h||h(),C(new o.SS(t.url,r,{startedAt:A.current.startedAt,openedAt:A.current.openedAt,lastMessagedAt:A.current.lastMessagedAt})))}),A.current.addEventListener("message",t=>{if(null==e||e(t),""===t.data)return;let r=JSON.parse(t.data);if("end"in r&&"[DONE]"===r.end){var a;null===(a=A.current)||void 0===a||a.close(),s()}null==n||n(r)}),A.current.addEventListener("exception_error",e=>{var n;A.current&&(null===(n=A.current)||void 0===n||n.close(),null==i||i(e),C(new o.l0(t.url,r,e,{startedAt:A.current.startedAt,openedAt:A.current.openedAt,lastMessagedAt:A.current.lastMessagedAt})))}),A.current.addEventListener("message_error",e=>{var n;A.current&&(null===(n=A.current)||void 0===n||n.close(),null==c||c(e),C(new o.eN(t.url,r,e,{startedAt:A.current.startedAt,openedAt:A.current.openedAt,lastMessagedAt:A.current.lastMessagedAt})))}),A.current.open()}).catch(t=>{var e;null===(e=A.current)||void 0===e||e.close(),C(t)})}),[d]),x=(0,r.useCallback)(()=>{var t,e;null===(t=A.current)||void 0===t||t.close(),(null===(e=A.current)||void 0===e?void 0:e.startedAt)&&(null==s||s({startedAt:A.current.startedAt,stoppedAt:new Date}))},[s]);return{stopStream:x,startStream:C}}n(27860),n(73656).env.REACT_APP_LAMBDA_NONE_GENERATE_URL,n(73656).env.REACT_APP_LAMBDA_NONE_GENERATE_URL;class R{async build(){let{email:t,platform:e,model:n,message:r,promptTemplateChatsId:a}=this.params;return{url:(0,i.f0)("".concat(this.baseURL,"/prompt-template-chats/").concat(a,"/stream"),{platform:e,user:t,model:n}),method:"POST",body:{message:r}}}constructor(t,e){this.baseURL=t,this.params=e}}function P(){let t=(0,r.useRef)(""),e=(0,r.useCallback)(()=>{t.current=""},[]),n=(0,r.useCallback)(()=>{t.current=""},[]),a=(0,r.useCallback)(()=>{t.current=""},[]),c=(0,r.useCallback)(e=>{"chunk"in e&&"string"==typeof e.chunk&&(t.current+=e.chunk,I.next({content:t.current,idle:!1}))},[]),l=(0,r.useCallback)(()=>{I.next({content:"",idle:!0})},[]),o=(0,r.useCallback)(()=>{},[]);return(0,r.useMemo)(()=>({onOpen:e,onMessageError:n,onExceptionError:a,onData:c,onIdle:l,onIdleTimeout:o}),[])}let N=()=>{let[t,e]=r.useState(""),n=(0,c.useRecoilValue)(d);return r.useEffect(()=>{"ready"!==n&&e("")},[n]),r.useEffect(()=>{let t=I.subscribe(t=>{e(t.content)});return()=>{t.unsubscribe()}},[]),t}},93452:function(){}}]);